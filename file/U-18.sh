#!/bin/bash

echo "=========================="
echo "U-18 (상)"
echo "점검 사항: 허용할 호스트에 대한 접속 IP 주소 제한 및 포트 제한 설정 여부 점검"
echo "=========================="

# 결과 초기화
tcp_wrapper_result="양호"
iptables_result="양호"
tcp_wrapper_reason="TCP Wrapper 설정이 적절하게 구성되어 있습니다."
iptables_reason="IPtables 설정이 적절하게 구성되어 있습니다."

# 1. TCP Wrapper 설정 점검

# /etc/hosts.allow 파일에서 허용된 호스트 확인
tcp_wrapper_allow=$(cat /etc/hosts.allow 2>/dev/null)
if [ -z "$tcp_wrapper_allow" ]; then
    tcp_wrapper_result="취약"
    tcp_wrapper_reason="/etc/hosts.allow 파일에 허용된 호스트 설정이 없습니다."
fi

# /etc/hosts.deny 파일에서 차단된 호스트 확인
tcp_wrapper_deny=$(cat /etc/hosts.deny 2>/dev/null)
if [ -z "$tcp_wrapper_deny" ]; then
    tcp_wrapper_result="취약"
    tcp_wrapper_reason="/etc/hosts.deny 파일에 차단된 호스트 설정이 없습니다."
fi

# 2. IPtables 설정 점검

# 현재 IPtables 규칙 확인
iptables_rules=$(sudo iptables -L -n -v 2>/dev/null)
if [ -z "$iptables_rules" ]; then
    iptables_result="취약"
    iptables_reason="IPtables 규칙이 설정되어 있지 않습니다."
fi

# 점검 결과 출력
echo "=== TCP Wrapper 점검 결과: $tcp_wrapper_result ==="
echo "이유: $tcp_wrapper_reason"
echo ""
echo "=== IPtables 점검 결과: $iptables_result ==="
echo "이유: $iptables_reason"

# TCP Wrapper 설정 출력
if [ "$tcp_wrapper_result" = "취약" ]; then
    echo "/etc/hosts.allow 설정:"
    echo "$tcp_wrapper_allow"
    echo ""
    echo "/etc/hosts.deny 설정:"
    echo "$tcp_wrapper_deny"
fi

# IPtables 규칙 출력
if [ "$iptables_result" = "취약" ]; then
    echo "IPtables 규칙:"
    echo "$iptables_rules"
fi

exit 0
