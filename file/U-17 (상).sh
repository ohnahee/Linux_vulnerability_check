#!/bin/bash

echo "▶ U-17 (상)◀"
echo "취약 판단 기준 : /etc/hosts.equiv 및 \$HOME/.rhosts 파일의 소유자가 root 또는 해당 계정이 아니거나 파일 권한이 600 이하가 아닌 경우, 파일 설정에 '+' 설정이 있는 경우 취약하다고 판단"

# 점검 대상 파일 목록
files=("/etc/hosts.equiv" "$HOME/.rhosts")

# 결과 초기화
vulnerable=false

# 파일 점검 함수
check_file() {
    local file=$1
    if [ -e "$file" ]; then
        local owner=$(stat -c %U "$file")
        local permissions=$(stat -c %a "$file")

        # 소유자 및 권한 진단
        if [[ "$file" == "/etc/hosts.equiv" && "$owner" != "root" ]]; then
            echo "$file 파일의 소유자가 root가 아닙니다. (현재 소유자: $owner)"
            vulnerable=true
        elif [[ "$file" != "/etc/hosts.equiv" && "$owner" != "$(whoami)" ]]; then
            echo "$file 파일의 소유자가 $(whoami) 계정이 아닙니다. (현재 소유자: $owner)"
            vulnerable=true
        fi

        if [ "$permissions" -gt "600" ]; then
            echo "$file 파일의 권한이 600 이하가 아닙니다. (현재 권한: $permissions)"
            vulnerable=true
        fi

        # 파일 설정에 '+'가 포함되어 있는지 확인
        if grep -q '+' "$file"; then
            echo "$file 파일에 '+' 설정이 포함되어 있습니다."
            vulnerable=true
        fi

        # 파일 상태 출력
        echo "$file 소유자: $owner, 권한: $permissions"
    else
        echo "$file 파일이 존재하지 않습니다."
    fi
}

# 각 파일 점검
for file in "${files[@]}"; do
    check_file "$file"
done

# 최종 결과 출력
if [ "$vulnerable" = true ]; then
    echo "※ 결과 : 취약(Vulnerable)"
else
    echo "※ 결과 : 양호(Good)"
    echo "/etc/hosts.equiv 및 \$HOME/.rhosts 파일의 소유자가 root 또는 해당 계정이고 권한이 600 이하이며 '+' 설정이 없습니다."
fi

exit 0
