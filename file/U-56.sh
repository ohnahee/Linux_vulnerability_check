#!/bin/bash

echo "=========================="
echo "U-56 (중)"
echo "점검 사항: 시스템 UMASK 값이 022 이상인지 점검"
echo "=========================="

# 결과 초기화
result="양호"
reason="UMASK 값이 022 이상으로 설정되어 있습니다."

# 현재 셸 세션에서 UMASK 값 확인
current_umask=$(umask)
if [ "$current_umask" -lt "0022" ]; then
    result="취약"
    reason="현재 셸 세션의 UMASK 값이 022 이상으로 설정되어 있지 않습니다. (현재 UMASK: $current_umask)"
fi

# 시스템 전체 설정 파일에서 UMASK 값 확인
umask_files=(
    "/etc/profile"
    "/etc/default/login"
    "/etc/bashrc"
    "/etc/csh.cshrc"
    "/etc/ksh.kshrc"
    "/etc/profile.d/*"
    "~/.bashrc"
    "~/.profile"
    "~/.cshrc"
    "~/.kshrc"
    "~/.login"
)

for file in "${umask_files[@]}"; do
    if [ -f $file ]; then
        file_umask=$(grep -E "umask" $file | awk '{print $2}')
        for umask_value in $file_umask; do
            if [ "$umask_value" -lt "0022" ]; then
                result="취약"
                reason="$file 파일에 UMASK 값이 022 이상으로 설정되어 있지 않습니다. (현재 UMASK: $umask_value)"
            fi
        done
    fi
done

# 점검 결과 출력
echo "=== 점검 결과: $result ==="
echo "이유: $reason"

# UMASK 설정 출력
echo ""
echo "현재 셸 세션의 UMASK 값:"
umask
echo ""

echo "시스템 전체 설정 파일에서 UMASK 값:"
for file in "${umask_files[@]}"; do
    if [ -f $file ]; then
        echo "$file:"
        grep -E "umask" $file
        echo ""
    fi
done

exit 0
