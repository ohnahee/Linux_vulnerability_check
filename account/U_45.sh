#!/bin/bash


echo "▶ U-45(하) | su 명령어 사용을 허용하는 사용자를 지정한 그룹이 설정되어 있는지 점검"
echo "▶ 판단 기준 : su 명령어를 모든 사용자가 사용하도록 설정되어 있는 경우 취약하다고 판단"

# /etc/pam.d/su 파일에서 pam_rootok.so 모듈이 설정되어 있는지 확인
if ! grep -q 'pam_rootok.so' /etc/pam.d/su; then
    echo "▶ U-45 결과 : 취약(Vulnerable)"
    echo " /etc/pam.d/su 파일에서 pam_rootok.so 모듈이 없습니다."
    exit 0
fi

# /etc/pam.d/su 파일에서 pam_wheel.so 모듈이 설정되어 있는지 확인
if ! grep -q 'pam_wheel.so' /etc/pam.d/su; then
    echo "▶ U-45 결과 : 취약(Vulnerable)"
    echo " /etc/pam.d/su 파일에 pam_wheel.so 모듈이 없습니다."
    exit 0
fi

# su 명령어 실행 파일의 권한을 점검
su_executables=("/bin/su" "/usr/bin/su")
if [ $(which su 2>/dev/null | wc -l) -gt 0 ]; then
    su_executables+=($(which su 2>/dev/null))
fi

for su_exec in "${su_executables[@]}"; do
    if [ -f $su_exec ]; then
        su_group_permission=$(stat -c %a $su_exec | cut -c 2)
        su_other_permission=$(stat -c %a $su_exec | cut -c 3)
        if [ "$su_group_permission" -eq 5 ] || [ "$su_group_permission" -eq 4 ] || [ "$su_group_permission" -eq 1 ] || [ "$su_group_permission" -eq 0 ]; then
            if [ "$su_other_permission" -ne 0 ]; then
                echo "▶ U-45 결과 : 취약(Vulnerable)"
                echo " $su_exec 실행 파일의 다른 사용자(other)에 대한 권한이 취약합니다."
                exit 0
            fi
        else
            echo "▶ U-45 결과 : 취약(Vulnerable)"
            echo " $su_exec 실행 파일의 그룹 사용자(group)에 대한 권한이 취약합니다."
            exit 0
        fi
    fi
done

echo "▶ U-45 결과 : 양호(Good)"
exit 0
