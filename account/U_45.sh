#!/bin/bash

echo "▶ U-45(하)◀"
echo " 취약 판단 기준 : su 명령어를 모든 사용자가 사용하도록 설정되어 있는 경우 취약하다고 판단"

# dpkg를 통해 libpam이 설치되어 있는지 확인
dpkg_libpam_count=`dpkg -l 2>/dev/null | grep 'libpam' | wc -l`
if [ $dpkg_libpam_count -gt 0 ]; then
    # pam_rootok.so 설정을 하지 않은 경우 하단의 첫 번째 if 문을 삭제하세요.
    etc_pamd_su_rootokso_count=`grep -vE '^#|^\s#' /etc/pam.d/su | grep 'pam_rootok.so' | wc -l`
    if [ $etc_pamd_su_rootokso_count -eq 0 ]; then
        echo "※ U-45 결과 : 취약(Vulnerable)"
        echo " /etc/pam.d/su 파일에서 pam_rootok.so 모듈이 없습니다."
        exit 0
    else
        # pam_wheel.so 설정에 trust 문구를 추가한 경우 하단의 if 문 조건절에 'grep 'trust'를 추가하세요.
        etc_pamd_su_wheelso_count=`grep -vE '^#|^\s#' /etc/pam.d/su | grep 'pam_wheel.so' | wc -l`
        if [ $etc_pamd_su_wheelso_count -eq 0 ]; then
            echo "※ U-45 결과 : 취약(Vulnerable)"
            echo " /etc/pam.d/su 파일에 pam_wheel.so 모듈이 없습니다."
            exit 0
        else
            echo "pam_rootok.so 모듈이 설정되어 있습니다."
            echo "pam_wheel.so 모듈이 설정되어 있습니다."
        fi
    fi
else
    su_executables=("/bin/su" "/usr/bin/su")
    if [ `which su 2>/dev/null | wc -l` -gt 0 ]; then
        su_executables[${#su_executables[@]}]=`which su 2>/dev/null`
    fi
    for su_exec in "${su_executables[@]}"; do
        if [ -f ${su_exec} ]; then
            su_permissions=$(stat -c %a ${su_exec})
            if [ "$su_permissions" -ne 4750 ]; then
                echo "※ U-45 결과 : 취약(Vulnerable)"
                echo " ${su_exec} 실행 파일의 권한이 4750이 아닙니다."
                exit 0
            fi
        fi
    done
fi

echo "※ U-45 결과 : 양호(Good)"
exit 0
