#!/bin/bash

echo "▶ U-02(상)◀"
echo취약 "판단 기준 : 패스워드 최소 길이 8자리 이상, 영문•숫자•특수문자 최소 입력 기능이 설정되지 않은 경우 취약하다고 판단"

# 점검 기준 설정
MINLEN=8
MINUPPER=-1
MINLOWER=-1
MINDIGIT=-1
MINSPECIAL=-1

# 설정 파일 경로
CONFIG_FILE="/etc/security/pwquality.conf"

# 설정 파일이 존재하는지 확인
if [ ! -f "$CONFIG_FILE" ]; then
    echo "※ U-02(상) 결과 : 취약(Vulnerable)"
    echo " 설정 파일($CONFIG_FILE)이 존재하지 않습니다."
    exit 1
fi

# 설정 파일에서 값 추출
minlen=$(grep -E "^minlen" "$CONFIG_FILE" | awk -F "=" '{print $2}' | xargs)
minupper=$(grep -E "^ucredit" "$CONFIG_FILE" | awk -F "=" '{print $2}' | xargs)
minlower=$(grep -E "^lcredit" "$CONFIG_FILE" | awk -F "=" '{print $2}' | xargs)
mindigit=$(grep -E "^dcredit" "$CONFIG_FILE" | awk -F "=" '{print $2}' | xargs)
minspecial=$(grep -E "^ocredit" "$CONFIG_FILE" | awk -F "=" '{print $2}' | xargs)

# 점검 결과 출력 함수
function check_setting {
    local setting_value="$1"
    local expected_value="$2"
    local description="$3"

    if [ -z "$setting_value" ]; then
        echo "※ U-02(상) 결과 : 취약(Vulnerable)"
        echo " $description 설정이 누락되었습니다."
        exit 1
    fi

    if [ "$setting_value" -gt "$expected_value" ]; then
        echo "※ U-02(상) 결과 : 취약(Vulnerable)"
        echo " $description 설정이 부족합니다. 현재 값: $setting_value, 요구 값: $expected_value"
        exit 1
    fi
}

# 설정 값 점검
check_setting "$minlen" "$MINLEN" "최소 패스워드 길이(minlen)"
check_setting "$minupper" "$MINUPPER" "대문자(ucredit)"
check_setting "$minlower" "$MINLOWER" "소문자(lcredit)"
check_setting "$mindigit" "$MINDIGIT" "숫자(dcredit)"
check_setting "$minspecial" "$MINSPECIAL" "특수문자(ocredit)"

echo "※ U-02(상) 결과 : 양호(Good)"
echo " 모든 패스워드 복잡성 설정이 올바르게 구성되어 있습니다."

exit 0
