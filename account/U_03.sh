#!/bin/bash

echo "▶ U-03(상)◀"
echo "취약 판단 기준 : pam_tally, pam_tally2, pam_faillock 모듈 중 하나라도 설정되지 않으면 취약하다고 판단"

# 설정 파일 경로
AUTH_FILE="/etc/pam.d/common-auth"
ACCOUNT_FILE="/etc/pam.d/common-account"
FAILLOCK_FILE="/etc/security/faillock.conf"

# 점검 기준 설정
DENY=5
UNLOCK_TIME=900

# pam_tally 설정 확인
tally_auth=$(grep -E "pam_tally.so" "$AUTH_FILE")
tally_account=$(grep -E "pam_tally.so" "$ACCOUNT_FILE")

# pam_tally2 설정 확인
tally2_auth=$(grep -E "pam_tally2.so" "$AUTH_FILE")
tally2_account=$(grep -E "pam_tally2.so" "$ACCOUNT_FILE")

# pam_faillock 설정 확인
faillock_auth=$(grep -E "pam_faillock.so" "$AUTH_FILE")
faillock_account=$(grep -E "pam_faillock.so" "$ACCOUNT_FILE")

# pam_faillock 설정 파일 확인
faillock_deny=$(grep -E "^deny\s*=\s*$DENY" "$FAILLOCK_FILE")
faillock_unlock_time=$(grep -E "^unlock_time\s*=\s*$UNLOCK_TIME" "$FAILLOCK_FILE")

# 결과 초기화
vulnerable=true

# pam_tally 진단
if [ -n "$tally_auth" ] && [ -n "$tally_account" ]; then
    echo "pam_tally 모듈이 올바르게 설정되었습니다."
    vulnerable=false
fi

# pam_tally2 진단
if [ -n "$tally2_auth" ] && [ -n "$tally2_account" ]; then
    echo "pam_tally2 모듈이 올바르게 설정되었습니다."
    vulnerable=false
fi

# pam_faillock 진단
if [ -n "$faillock_auth" ] && [ -n "$faillock_account" ] && [ -n "$faillock_deny" ] && [ -n "$faillock_unlock_time" ]; then
    echo "pam_faillock 모듈이 올바르게 설정되었습니다."
    vulnerable=false
fi

# 최종 결과 출력
if [ "$vulnerable" = true ]; then
    echo "※ 결과 : 취약(Vulnerable)"
    echo " 세 가지 계정 잠금 모듈 중 하나도 올바르게 설정되지 않았습니다."
else
    echo "※ 결과 : 양호(Good)"
    echo " 세 가지 계정 잠금 모듈 중 하나 이상이 올바르게 설정되었습니다."
fi

exit 0
