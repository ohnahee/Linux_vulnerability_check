#!/bin/bash

echo "=========================="
echo "U-02 (상)"
echo "점검 사항 : 사용자 계정의 패스워드 복잡성 설정을 점검"
echo "참고 : 이전 버전에서는 /etc/pam.d/common-password 파일에서 pam_unix.so 및 pam_cracklib.so 모듈을 사용하여 패스워드 복잡성 설정을 관리"
echo "=========================="

# 패스워드 복잡성 설정 파일 경로
PWQUALITY_CONFIG="/etc/security/pwquality.conf"

# 권장 값
RECOMMENDED_LCREDIT=-1
RECOMMENDED_UCREDIT=-1
RECOMMENDED_DCREDIT=-1
RECOMMENDED_OCREDIT=-1
RECOMMENDED_MINLEN=8

# 점검 결과 변수 초기화
result="양호"
reason="사용자 계정의 패스워드 복잡성 설정이 적절하게 되어 있습니다."

# 패스워드 복잡성 설정 점검
if [ -f "$PWQUALITY_CONFIG" ]; then
    echo "$PWQUALITY_CONFIG 파일이 존재합니다."

    lcredit=$(grep -E "^lcredit" $PWQUALITY_CONFIG | awk '{print $3}')
    ucredit=$(grep -E "^ucredit" $PWQUALITY_CONFIG | awk '{print $3}')
    dcredit=$(grep -E "^dcredit" $PWQUALITY_CONFIG | awk '{print $3}')
    ocredit=$(grep -E "^ocredit" $PWQUALITY_CONFIG | awk '{print $3}')
    minlen=$(grep -E "^minlen" $PWQUALITY_CONFIG | awk '{print $3}')

    if [[ "$lcredit" != "$RECOMMENDED_LCREDIT" ]]; then
        result="취약"
        reason="lcredit 설정이 권장 값과 다릅니다. (현재: $lcredit, 권장: $RECOMMENDED_LCREDIT)"
    fi

    if [[ "$ucredit" != "$RECOMMENDED_UCREDIT" ]]; then
        result="취약"
        reason="ucredit 설정이 권장 값과 다릅니다. (현재: $ucredit, 권장: $RECOMMENDED_UCREDIT)"
    fi

    if [[ "$dcredit" != "$RECOMMENDED_DCREDIT" ]]; then
        result="취약"
        reason="dcredit 설정이 권장 값과 다릅니다. (현재: $dcredit, 권장: $RECOMMENDED_DCREDIT)"
    fi

    if [[ "$ocredit" != "$RECOMMENDED_OCREDIT" ]]; then
        result="취약"
        reason="ocredit 설정이 권장 값과 다릅니다. (현재: $ocredit, 권장: $RECOMMENDED_OCREDIT)"
    fi

    if [[ "$minlen" != "$RECOMMENDED_MINLEN" ]]; then
        result="취약"
        reason="minlen 설정이 권장 값과 다릅니다. (현재: $minlen, 권장: $RECOMMENDED_MINLEN)"
    fi
else
    result="취약"
    reason="$PWQUALITY_CONFIG 파일이 존재하지 않습니다."
fi

# 점검 결과 출력
echo "=== 점검 결과: $result ==="
echo "이유: $reason"
