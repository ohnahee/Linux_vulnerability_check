#!/bin/bash

echo "=========================="
echo "U-03 (상)"
echo "점검 사항 : 사용자 계정 로그인 실패 시 계정 잠금 임계값 설정 점검"
echo "참고 : 이전 버전에서는 /etc/pam.d/common-auth 파일에서 pam_tally2.so 또는 pam_faillock.so 모듈을 사용하여 계정 잠금 임계값을 설정하였습니다."
echo "=========================="

# PAM 설정 파일 경로
AUTH_CONFIG="/etc/pam.d/common-auth"

# 권장 값
RECOMMENDED_DENY=10
RECOMMENDED_UNLOCK_TIME=600
RECOMMENDED_FAIL_INTERVAL=900

# 점검 결과 변수 초기화
result="양호"
reason="로그인 실패 시 계정 잠금 임계값이 적절하게 설정되어 있습니다."

# common-auth 파일 점검
if [ -f "$AUTH_CONFIG" ]; then
    if grep -q "pam_faillock.so" $AUTH_CONFIG; then
        echo "$AUTH_CONFIG 파일에 pam_faillock.so 설정이 존재합니다."

        deny=$(grep "pam_faillock.so" $AUTH_CONFIG | grep -o "deny=[0-9]*" | cut -d= -f2 | head -n 1)
        unlock_time=$(grep "pam_faillock.so" $AUTH_CONFIG | grep -o "unlock_time=[0-9]*" | cut -d= -f2 | head -n 1)
        fail_interval=$(grep "pam_faillock.so" $AUTH_CONFIG | grep -o "fail_interval=[0-9]*" | cut -d= -f2 | head -n 1)

        if [[ -z "$deny" || "$deny" -lt 10 ]]; then
            result="취약"
            reason="pam_faillock.so 모듈의 deny 설정이 권장 값과 다르거나 설정되어 있지 않습니다. (현재: ${deny:-없음}, 권장: 10회 이상)"
        fi

        if [[ -z "$unlock_time" || "$unlock_time" -ne "$RECOMMENDED_UNLOCK_TIME" ]]; then
            result="취약"
            reason="pam_faillock.so 모듈의 unlock_time 설정이 권장 값과 다릅니다. (현재: ${unlock_time:-없음}, 권장: $RECOMMENDED_UNLOCK_TIME)"
        fi

        if [[ -z "$fail_interval" || "$fail_interval" -ne "$RECOMMENDED_FAIL_INTERVAL" ]]; then
            result="취약"
            reason="pam_faillock.so 모듈의 fail_interval 설정이 권장 값과 다릅니다. (현재: ${fail_interval:-없음}, 권장: $RECOMMENDED_FAIL_INTERVAL)"
        fi
    else
        result="취약"
        reason="$AUTH_CONFIG 파일에 pam_faillock.so 설정이 존재하지 않습니다."
    fi
else
    result="취약"
    reason="$AUTH_CONFIG 파일이 존재하지 않습니다."
fi

# 점검 결과 출력
echo "=== 점검 결과: $result ==="
echo "이유: $reason"
