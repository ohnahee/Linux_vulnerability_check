#!/bin/bash

echo "=========================="
echo "U-04 (상)"
echo "점검 사항 : 사용자 계정 패스워드 암호화 저장 및 쉐도우 패스워드 정책 적용"
echo "=========================="

# /etc/passwd 파일 점검
check_passwd_file() {
    echo "/etc/passwd 파일 점검"
    passwd_check=$(grep -v '^[^:]*:x:' /etc/passwd | grep -vE '^(root|daemon|bin|sys|sync|games|man|lp|mail|news|uucp|proxy|www-data|backup|list|irc|_apt|nobody|systemd-network|systemd-timesync|dhcpcd|messagebus|syslog|systemd-resolve|uuidd|usbmux|tss|systemd-oom|kernoops|whoopsie|dnsmasq|avahi|tcpdump|sssd|speech-dispatcher|cups-pk-helper|fwupd-refresh|saned|geoclue|cups-browsed|hplip|polkitd|rtkit|colord|gnome-initial-setup|gdm|nm-openvpn|gnome-remote-desktop)')
    if [ -n "$passwd_check" ]; then
        echo "취약: /etc/passwd 파일에 패스워드 필드가 x로 설정되지 않은 항목이 있습니다:"
        echo "$passwd_check"
    else
        echo "양호: /etc/passwd 파일의 모든 사용자 계정이 적절히 설정되어 있습니다."
    fi
}

# /etc/shadow 파일 점검
check_shadow_file() {
    echo "/etc/shadow 파일 점검"
    shadow_check=$(sudo awk -F: '($2 == "" || $2 == "*" || $2 == "!" || $2 ~ /^\$[156]\$/) {next} {print $1": NOT OK"}' /etc/shadow | grep -vE '^(root|daemon|bin|sys|sync|games|man|lp|mail|news|uucp|proxy|www-data|backup|list|irc|_apt|nobody|systemd-network|systemd-timesync|dhcpcd|messagebus|syslog|systemd-resolve|uuidd|usbmux|tss|systemd-oom|kernoops|whoopsie|dnsmasq|avahi|tcpdump|sssd|speech-dispatcher|cups-pk-helper|fwupd-refresh|saned|geoclue|cups-browsed|hplip|polkitd|rtkit|colord|gnome-initial-setup|gdm|nm-openvpn|gnome-remote-desktop)')
    if [ -n "$shadow_check" ]; then
        echo "취약: /etc/shadow 파일에 암호화되지 않은 패스워드가 저장된 사용자 계정이 있습니다:"
        echo "$shadow_check"
    else
        echo "양호: /etc/shadow 파일의 모든 사용자 계정 패스워드가 적절히 암호화되어 있습니다."
    fi
}

# 점검 실행
check_passwd_file
check_shadow_file
