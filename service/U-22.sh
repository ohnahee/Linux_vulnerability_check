#!/bin/bash

echo "=========================="
echo "U-22 (상)"
echo "점검 사항 : crontab 명령어 및 cron 관련 파일 권한 점검"
echo "=========================="

# 점검 결과 변수 초기화
result="양호"
reason="모든 권한이 적절합니다."

# crontab 명령어 권한 점검
crontab_perms=$(stat -c "%a" /usr/bin/crontab)
crontab_owner=$(stat -c "%U" /usr/bin/crontab)
if [ "$crontab_perms" -gt 750 ]; then
    result="취약"
    reason="/usr/bin/crontab 파일의 권한이 적절하지 않습니다. (현재 권한: $crontab_perms)"
fi

# /etc/crontab 파일 권한 점검
crontab_perms=$(stat -c "%a" /etc/crontab)
crontab_owner=$(stat -c "%U" /etc/crontab)
if [ "$crontab_perms" -gt 640 ]; then
    result="취약"
    reason="/etc/crontab 파일의 권한이 적절하지 않습니다. (현재 권한: $crontab_perms)"
fi

# /etc/cron.d/ 디렉토리 내 파일 권한 점검
for file in /etc/cron.d/*; do
    if [ -f "$file" ]; then
        file_perms=$(stat -c "%a" "$file")
        if [ "$file_perms" -gt 640 ]; then
            result="취약"
            reason="$file 파일의 권한이 적절하지 않습니다. (현재 권한: $file_perms)"
            break
        fi
    fi
done

# /etc/cron.hourly/ 디렉토리 내 파일 권한 점검
for file in /etc/cron.hourly/*; do
    if [ -f "$file" ]; then
        file_perms=$(stat -c "%a" "$file")
        if [ "$file_perms" -gt 640 ]; then
            result="취약"
            reason="$file 파일의 권한이 적절하지 않습니다. (현재 권한: $file_perms)"
            break
        fi
    fi
done

# /etc/cron.daily/ 디렉토리 내 파일 권한 점검
for file in /etc/cron.daily/*; do
    if [ -f "$file" ]; then
        file_perms=$(stat -c "%a" "$file")
        if [ "$file_perms" -gt 640 ]; then
            result="취약"
            reason="$file 파일의 권한이 적절하지 않습니다. (현재 권한: $file_perms)"
            break
        fi
    fi
done

# /etc/cron.weekly/ 디렉토리 내 파일 권한 점검
for file in /etc/cron.weekly/*; do
    if [ -f "$file" ]; then
        file_perms=$(stat -c "%a" "$file")
        if [ "$file_perms" -gt 640 ]; then
            result="취약"
            reason="$file 파일의 권한이 적절하지 않습니다. (현재 권한: $file_perms)"
            break
        fi
    fi
done

# /etc/cron.monthly/ 디렉토리 내 파일 권한 점검
for file in /etc/cron.monthly/*; do
    if [ -f "$file" ]; then
        file_perms=$(stat -c "%a" "$file")
        if [ "$file_perms" -gt 640 ]; then
            result="취약"
            reason="$file 파일의 권한이 적절하지 않습니다. (현재 권한: $file_perms)"
            break
        fi
    fi
done

# 사용자별 crontab 파일 권한 점검
for file in /var/spool/cron/crontabs/*; do
    if [ -f "$file" ]; then
        file_perms=$(stat -c "%a" "$file")
        if [ "$file_perms" -gt 600 ]; then
            result="취약"
            reason="$file 파일의 권한이 적절하지 않습니다. (현재 권한: $file_perms)"
            break
        fi
    fi
done

# 점검 결과 출력
echo "=== 점검 결과: $result ==="
echo "이유: $reason"
