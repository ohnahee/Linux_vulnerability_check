#!/bin/bash

echo "=========================="
echo "U-23 (상)"
echo "점검 사항: 사용하지 않는 DoS 공격에 취약한 서비스의 실행 여부 점검"
echo "=========================="

# 점검 결과 변수 초기화
result="양호"
reason="모든 DoS 공격에 취약한 서비스가 비활성화 되어 있습니다."

# 점검할 서비스 목록 및 명령어
services=(
    "echo|discard|daytime|chargen"  # xinetd/inetd 서비스
    "ntp"                            # NTP 서비스
    "chrony"                         # NTP 서비스 (대안)
    "named"                          # DNS (BIND) 서비스
    "snmpd"                          # SNMP 서비스
)

# Echo, Discard, Daytime, Chargen 서비스 점검 (xinetd 사용 시)
xinetd_services=$(sudo grep -rE "${services[0]}" /etc/xinetd.d/)
if [ ! -z "$xinetd_services" ]; then
    result="취약"
    reason="xinetd에서 다음 서비스가 활성화 되어 있습니다: $xinetd_services"
fi

# Echo, Discard, Daytime, Chargen 서비스 점검 (inetd 사용 시)
inetd_services=$(sudo grep -E "${services[0]}" /etc/inetd.conf)
if [ ! -z "$inetd_services" ]; then
    result="취약"
    reason="inetd에서 다음 서비스가 활성화 되어 있습니다: $inetd_services"
fi

# NTP 서비스 점검
ntp_status=$(sudo systemctl is-active ntp)
if [ "$ntp_status" == "active" ]; then
    result="취약"
    reason="NTP 서비스(ntp)가 활성화 되어 있습니다."
fi

# Chrony 서비스 점검
chrony_status=$(sudo systemctl is-active chrony)
if [ "$chrony_status" == "active" ]; then
    result="취약"
    reason="NTP 서비스(chrony)가 활성화 되어 있습니다."
fi

# DNS (BIND) 서비스 점검
dns_status=$(sudo systemctl is-active named)
if [ "$dns_status" == "active" ]; then
    result="취약"
    reason="DNS (BIND) 서비스(named)가 활성화 되어 있습니다."
fi

# SNMP 서비스 점검
snmp_status=$(sudo systemctl is-active snmpd)
if [ "$snmp_status" == "active" ]; then
    result="취약"
    reason="SNMP 서비스(snmpd)가 활성화 되어 있습니다."
fi

# 점검 결과 출력
echo "=== 점검 결과: $result ==="
echo "이유: $reason"
